<?php
echo $this->UIPageTitleFormatter($this->navigation('navigation')->findActive('navigation')['page']->label);

$form->setAttribute('action', $this->url('business-admin/products', array('action' => 'add')));
$form->setAttributes(array('class' => 'form-horizontal'));
$form->prepare();
?>

<div class="well bs-component">

    <?php echo$this->form()->openTag($form) ?>

    <fieldset>
        <legend>Add New Product</legend>
        <div id="NewProductBlock" class="in ">

            <?php echo $this->formHidden($form->get('ProductID')->setValue(0)) ?>

            <div class="form-group">
                <label class="col-lg-2 control-label" for="ProductName">Product Name:</label>
                <div class="col-lg-10">
                    <?php echo $this->formRow($form->get('ProductName')); ?>
                </div>
            </div>

            <div class="form-group">
                <label class="col-lg-2 control-label" for="SKU">SKU:</label>
                <div class="col-lg-10">
                    <?php echo $this->formRow($form->get('SKU')); ?>
                </div>
            </div>

            <div class="form-group">
                <label class="col-lg-2 control-label" for="CollectionID">Collection:</label>
                <div class="col-lg-10">
                    <?php echo $this->formRow($form->get('CollectionID')); ?>
                </div>
            </div>

            <div class="form-group">
                <label class="col-lg-2 control-label" for="ProductTypeID">Product Type:</label>
                <div class="col-lg-10">
                    <?php echo $this->formRow($form->get('ProductTypeID')); ?>
                </div>
            </div>

            <div class="form-group">
                <label class="col-lg-2 control-label" for="Strands">Strands:</label>
                <div class="col-lg-10">
                    <?php echo $this->formRow($form->get('Strands')); ?>
                </div>
            </div>

            <div class="form-group">
                <label class="col-lg-2 control-label" for="IntroDate">Date Introduced:</label>
                <div class="col-lg-10">
                    <?php echo $this->formRow($form->get('IntroDate')->setValue(date('Y-m-d'))); ?>
                </div>
            </div>

        </div>

    </fieldset>

    <fieldset>
        <legend>Raw Materials</legend>
        <?php #echo $this->UIProductRawMaterialsManager(TRUE, $this->rawMaterials)['rmReturnBlock']; ?>

        <div class="row">
            <div class="col-lg-10 col-lg-offset-2">
                <table id="jqGrid"></table>
                <div id="jqGridPager"></div>
            </div>
        </div>
        <script type="text/javascript">
            $(document).ready(function () {
                var rawMaterialTypes = function () {
                    var rtnData = null;
                    $.ajax({
                        async: false,
                        url: "/business-admin/raw-material-types/jsonFetchAll",
                        success: function (data, result) {
                            rtnData = '0:Select ...;';
                            if (!result) {
                                alert('ERROR');
                            } else {
                                for (var x = 0; x < data.rawMaterialTypes.length; x++) {
                                    rtnData += data.rawMaterialTypes[x]['id'] + ':' + data.rawMaterialTypes[x]['value'];
                                    if (data.rawMaterialTypes.length - 1 > x) {
                                        rtnData += ';'
                                    }
                                }
                            }
                        }
                    });
                    return rtnData;
                }();
                var rawMaterials = function () {
                    var rtnData = null;
                    $.ajax({
                        async: false,
                        url: "/business-admin/raw-materials/jsonMaterialsByType",
                        data: {RawMaterialTypeId: 35},
                        success: function (data, result) {
                            rtnData = '0:Select ...;';
                            if (!result) {
                                alert('ERROR');
                            } else {
                                for (var x = 0; x < data.rawMaterials.length; x++) {
                                    rtnData += data.rawMaterials[x]['RawMaterialID'] + ':' + data.rawMaterials[x]['RawMaterialName'];
                                    if (data.rawMaterials.length - 1 > x) {
                                        rtnData += ';'
                                    }
                                }
                            }
                        }
                    });
                    return rtnData;
                }();
                onclickSubmitLocal = function (options, postdata) {
                    console.log(options);
                    console.log(postdata);
                    this.processing = true;
                    return {};
                }

                $.jgrid.defaults.responsive = true;
                $.jgrid.defaults.styleUI = 'Bootstrap';
                $("#jqGrid").jqGrid({
                    url: '/business-admin/raw-materials/jsonMaterialsByProduct?productid=1855',
                    mtype: "GET",
                    styleUI: 'Bootstrap',
                    datatype: "json",
                    viewrecords: true,
                    loadonce: false,
                    sortname: 'RMTypeName',
                    height: 'auto',
                    viewsortcols: [true, 'vertical', true],
                    pager: "#jqGridPager",
                    editurl: 'clientArray',
                    loadComplete: function () {
                        $("#jqGrid").setColProp('RMTypeName', {editoptions: {value: rawMaterialTypes}});
                        $("#jqGrid").setColProp('RawMaterialName', {editoptions: {value: rawMaterials}});
                    },
                    colModel: [
                        {
                            name: 'RMTypeID',
                            hidden: true
                        },
                        {
                            label: 'Raw Material Type',
                            name: 'RMTypeName',
                            width: 200,
                            editable: true,
                            edittype: 'select',
                            editoptions: {
                                readonly: true,
                                size: 0
                            },
                        },
                        {
                            name: 'RawMaterialID',
                            hidden: true
                        },
                        {
                            label: 'Raw Material Name',
                            name: 'RawMaterialName',
                            width: 200,
                            editable: true,
                            edittype: "select",
                            editoptions: {
                                value: "Select a City"
                            }
                        },
                        {
                            label: 'Code',
                            name: 'RawMaterialCode',
                            width: 75,
                            editable: false
                        },
                        {
                            name: 'RMSupplierID',
                            hidden: true
                        },
                        {
                            label: 'Supplier',
                            name: 'RMSupplierName',
                            width: 150,
                            editable: false
                        },
                        {
                            label: 'Qty',
                            name: 'RawMaterialQty',
                            width: 75,
                            edittype: "text",
                            editable: true,
                        },
                        {
                            label: 'Cost',
                            name: 'RawMaterialUnitCost',
                            width: 75,
                            edittype: "text",
                            editable: true,
                            editoptions: {
                                readonly: true
                            }
                        },
                        {
                            label: 'Subtotal',
                            name: 'Subtotal',
                            width: 75,
                            edittype: "text",
                            editable: true,
                            editoptions: {
                                readonly: true,
                            }
                        }
                    ]
                });
                $('#jqGrid').navGrid('#jqGridPager', {
                    edit: true,
                    add: true,
                    del: true,
                    search: false,
                    refresh: false,
                    view: false,
                    position: "left",
                    cloneToTop: true
                },
                {
                    // EDIT
                    editCaption: "Edit this Raw Material",
                    recreateForm: false,
                    closeAfterEdit: true,
                    viewPagerButtons: false,
                    afterShowForm: RawMaterialData,
                    errorTextFormat: function (data) {
                        return 'Error: ' + data.responseText
                    },
                    reloadAfterSubmit: false,
                    closeOnEscape: true,
                    savekey: [true, 13],
                    onclickSubmit: onclickSubmitLocal
                },
                {
                    // ADD
                    closeAfterAdd: true,
                    recreateForm: false,
                    errorTextFormat: function (data) {
                        return 'Error: ' + data.responseText
                    }
                },
                {
                    // DELETE
                    errorTextFormat: function (data) {
                        return 'Error: ' + data.responseText
                    }
                });

                function RawMaterialData() {
                    updateRawMaterialCallBack($("#RMTypeName").val(), true);
                    $("#RMTypeName").bind("change", function (e) {
                        updateRawMaterialCallBack($("#RMTypeName").val(), false);
                    });
                    return false;
                }

                function updateRawMaterialCallBack(RawMaterialTypeId, setselected) {
                    var current = $("#jqGrid").jqGrid('getRowData', $("#jqGrid")[0].p.selrow).RawMaterialID;
                    //console.log(current);
                    $("#RawMaterialName")
                            .html("<option value=''>Loading Raw Materials...</option>")
                            .attr("disabled", "disabled");
                    $.ajax({
                        url: "/business-admin/raw-materials/jsonMaterialsByType?RawMaterialTypeId=" + RawMaterialTypeId,
                        type: "GET",
                        success: function (data) {
                            var selectHtml = '<select>';
                            for (var x = 0; x < data.rawMaterials.length; x++) {
                                selectHtml += '<option value="' + data.rawMaterials[x]['RawMaterialID'] + '">' + data.rawMaterials[x]['RawMaterialName'] + '</option>';
                            }
                            selectHtml += '</select>';
                            $("#RawMaterialName")
                                    .removeAttr("disabled")
                                    .html(selectHtml);
                            if (setselected) {
                                $("#RawMaterialName").val(current);
                            }
                        }
                    });
                }

            });</script>
        <script type="application/javascript" src="/js/jqGrid/bootstrap/integrations/amdsupport/js/i18n/grid.locale-en.js?v=1"></script>
        <script type="application/javascript" src="/js/jqGrid/js/trirand/jquery.jqGrid.min.js"></script>


    </fieldset>

    <!-- /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// --->

    <fieldset>
        <legend>Labour</legend>
    </fieldset>

    <!-- /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// --->

    <fieldset>
        <legend>Dispatch</legend>

    </fieldset>

    <!-- /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// --->

    <fieldset>
        <legend>Packaging</legend>

    </fieldset>

    <!-- /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// --->

    <fieldset>
        <legend>Financial</legend>

    </fieldset>

    <div class="form-group">
        <div class="col-lg-3 col-lg-offset-9">
            <a href="/business-admin/raw-material-types" type="reset" class="btn btn-default">Cancel</a>
            <?php echo $this->formSubmit($form->get('submit')); ?>
        </div>
    </div>

    <!-- /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// --->

    <div class="modal fade" id="buildProductName" tabindex="-1" role="dialog" aria-labelledby="buildProductNameLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                    <h4 class="modal-title" id="buildProductNameLabel">Build Product Name</h4>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label class="col-lg-3 control-label" for="Name">Name:</label>
                        <div class="col-lg-9">
                            <?php echo $this->formRow($form->get('Name')); ?>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-lg-3 control-label" for="NameCharm">Choose Charm:</label>
                        <div class="col-lg-9">
                            <?php echo $this->formRow($form->get('NameCharm')); ?>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-lg-3 control-label" for="NameCrystal">Choose Crystal:</label>
                        <div class="col-lg-9">
                            <?php echo $this->formRow($form->get('NameCrystal')); ?>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-lg-3 control-label" for="NameColour">Choose Colour:</label>
                        <div class="col-lg-9">
                            <?php echo $this->formRow($form->get('NameColour')); ?>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-lg-3 control-label" for="NameLength">Choose Length:</label>
                        <div class="col-lg-9">
                            <?php echo $this->formRow($form->get('NameLength')); ?>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" id="buildProductNameSave" class="btn btn-success" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// --->

    <div class="modal fade" id="manageRawMaterials" tabindex="-1" role="dialog" aria-labelledby="manageRawMaterialsLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                    <h4 class="modal-title" id="manageRawMaterialsLabel">Add Raw Material</h4>
                </div>
                <div class="modal-body">
                    <select name="testSelect" id="testSelect">
                        <option value="1">testSelect - 1</option>
                        <option value="2">testSelect - 2</option>
                        <option value="3">testSelect - 3</option>
                        <option value="4">testSelect - 4</option>
                        <option value="5">testSelect - 5</option>
                    </select>
                </div>
                <div class="modal-footer">
                    <button type="button" id="addRawMaterialSave" class="btn btn-success" data-dismiss="modal">Add</button>
                </div>
            </div>
        </div>
    </div>

    <!-- /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// --->

    <?php echo $this->form()->closeTag(); ?>

</div>

<script>
            $(document).ready(function () {
                $('#ProductName').focus(function () {
                    $('#buildProductName').modal('show');
                    $('#Name').focus();
                });
                $('#buildProductName').on('hidden.bs.modal', function () {
                    $('#SKU').focus();
                });
                //=============================================
                var rawMaterialArr = [];
                rawMaterialEdit = function (editDataId) {
                    console.log(editDataId);
                    if (editDataId > 0) {
                        console.log(rawMaterialArr[editDataId]);
                    }
                    return false;
                }
                rawMaterialAdd = function () {
                    var rawMaterialData = {"RawMaterialData":
                                [{
                                        "RawMaterialType": $('#testSelect').val(),
                                        "RawMaterialName": "RawMaterialName",
                                        "Code": "Code",
                                        "Supplier": "Supplier",
                                        "Qty": "Qty",
                                        "Cost": "Cost",
                                        "Subtotal": "Subtotal"
                                    }]};
                    rawMaterialArr.push(rawMaterialData);
                    console.log(rawMaterialArr);
                    newRowMaterial = '<tr>';
                    newRowMaterial += '<td>' + rawMaterialData['RawMaterialData'][0]['RawMaterialType'] + '</td>';
                    newRowMaterial += '<td>' + rawMaterialData['RawMaterialData'][0]['RawMaterialName'] + '</td>';
                    newRowMaterial += '<td>' + rawMaterialData['RawMaterialData'][0]['Code'] + '</td>';
                    newRowMaterial += '<td>' + rawMaterialData['RawMaterialData'][0]['Supplier'] + '</td>';
                    newRowMaterial += '<td>' + rawMaterialData['RawMaterialData'][0]['Qty'] + '</td>';
                    newRowMaterial += '<td>' + rawMaterialData['RawMaterialData'][0]['Cost'] + '</td>';
                    newRowMaterial += '<td>' + rawMaterialData['RawMaterialData'][0]['Subtotal'] + '</td>';
                    newRowMaterial += '<td><button onclick="rawMaterialEdit(' + (rawMaterialArr.length - 1) + ')" type="button" class="btn btn-warning btn-sm margin-right-5"><span class="glyphicon glyphicon-pencil"></span></button>';
                    newRowMaterial += '<button onclick="rawMaterialDelete(this)" type="button" id="rmD_' + (rawMaterialArr.length - 1) + '" class="btn btn-danger btn-sm"><span class="glyphicon glyphicon-trash"></span></button></td>';
                    newRowMaterial += '</tr>';
                    $("#rawMaterialsTable tbody").append(newRowMaterial);
                    return false;
                };
                rawMaterialDelete = function (elem) {
                    var rmDataId = elem.id.split('_');
                    elem.closest('tr').remove();
                    console.log(rmDataId[1]);
                    rawMaterialArr.splice(rmDataId[1], 1);
                    console.log(rawMaterialArr);
                    return false;
                };
                $('#addRawMaterialAction').click(function () {
                    $('#manageRawMaterials').modal('show');
                    return false;
                });
                $('#addRawMaterialSave').click(function () {
                    rawMaterialAdd();
                    $('#manageRawMaterials').modal('hide');
                    return false;
                });
                //=============================================
                $("#IntroDate").datepicker({
                    autoclose: true,
                    dateFormat: "yy-mm-dd",
                    format: 'dd-mm-yy',
                    altFormat: "yy-mm-dd",
                    orientation: 'bottom',
                    changeMonth: true,
                    changeYear: true
                });
                //=============================================
                $("#Name").bind('keyup', function () {
                    concatName();
                });
                $("#Charm").bind('change', function () {
                    concatName();
                });
                $("#Chrystal").bind('change', function () {
                    concatName();
                });
                $("#Colour").bind('change', function () {
                    concatName();
                });
                $("#Length").bind('change', function () {
                    concatName();
                });
                $("#buildProductNameSave").click(function () {
                    concatName();
                });
                concatName = function () {
                    $("#ProductName").val($("#Name").val());
                    if ($("#NameCharm").val()) {
                        $("#ProductName").val($("#ProductName").val() + ' - ' + $("#NameCharm").val());
                    }
                    if ($("#NameCrystal").val()) {
                        $("#ProductName").val($("#ProductName").val() + ' - ' + $("#NameCrystal").val());
                    }
                    if ($("#NameColour").val()) {
                        $("#ProductName").val($("#ProductName").val() + ' - ' + $("#NameColour").val());
                    }
                    if ($("#NameLength").val()) {
                        $("#ProductName").val($("#ProductName").val() + ' - ' + $("#NameLength").val());
                    }
                };
            });
</script>
